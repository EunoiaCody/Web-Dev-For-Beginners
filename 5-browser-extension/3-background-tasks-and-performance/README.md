# æµè§ˆå™¨æ‰©å±•é¡¹ç›® ç¬¬ 3 éƒ¨åˆ†ï¼šäº†è§£åå°ä»»åŠ¡ä¸æ€§èƒ½

## è¯¾å‰æµ‹éªŒ

[Pre-lecture quiz](https://ff-quizzes.netlify.app/web/quiz/27)

### ä»‹ç»

åœ¨æœ¬æ¨¡å—å‰ä¸¤è¯¾ä¸­ï¼Œä½ å­¦ä¹ äº†å¦‚ä½•æ„å»ºä¸€ä¸ªè¡¨å•ä¸ç”¨äºå±•ç¤ºä» API è·å–æ•°æ®çš„æ˜¾ç¤ºåŒºåŸŸã€‚è¿™æ˜¯ä¸€ç§éå¸¸æ ‡å‡†çš„ Web æ„å»ºæ–¹å¼ã€‚ä½ è¿˜å­¦ä¹ äº†å¦‚ä½•ä»¥å¼‚æ­¥æ–¹å¼è·å–æ•°æ®ã€‚ä½ çš„æµè§ˆå™¨æ‰©å±•å·²ç»æ¥è¿‘å®Œæˆã€‚

æ¥ä¸‹æ¥éœ€è¦å¤„ç†ä¸€äº›åå°ä»»åŠ¡ï¼ŒåŒ…æ‹¬åˆ·æ–°æ‰©å±•å›¾æ ‡çš„é¢œè‰²ã€‚ç°åœ¨æ­£æ˜¯è®¨è®ºæµè§ˆå™¨å¦‚ä½•ç®¡ç†æ­¤ç±»ä»»åŠ¡çš„å¥½æ—¶æœºã€‚è®©æˆ‘ä»¬åœ¨æ„å»º Web èµ„æºæ—¶ï¼Œä»æ€§èƒ½çš„è§’åº¦æ€è€ƒè¿™äº›æµè§ˆå™¨ä»»åŠ¡ã€‚

## Web æ€§èƒ½åŸºç¡€

> â€œç½‘ç«™æ€§èƒ½å½’ç»“äºä¸¤ç‚¹ï¼šé¡µé¢åŠ è½½æœ‰å¤šå¿«ï¼Œé¡µé¢ä¸Šçš„ä»£ç è¿è¡Œæœ‰å¤šå¿«ã€‚â€â€”â€” [Zack Grossbart](https://www.smashingmagazine.com/2012/06/javascript-profiling-chrome-developer-tools/)

å¦‚ä½•è®©ä½ çš„ç½‘ç«™åœ¨å„ç§è®¾å¤‡ã€å„ç§ç”¨æˆ·ã€å„ç§æƒ…å¢ƒä¸‹éƒ½é£å¿«ï¼Œè¿™ä¸ªè¯é¢˜éå¸¸åºå¤§ã€‚æ— è®ºæ˜¯æ ‡å‡† Web é¡¹ç›®è¿˜æ˜¯æµè§ˆå™¨æ‰©å±•ï¼Œæ„å»ºæ—¶è¯·è®°ä½ä»¥ä¸‹è¦ç‚¹ã€‚

è¦ç¡®ä¿ç½‘ç«™é«˜æ•ˆè¿è¡Œï¼Œé¦–å…ˆè¦åšçš„æ˜¯æ”¶é›†å…¶æ€§èƒ½æ•°æ®ã€‚æœ€ä½³èµ·ç‚¹å°±æ˜¯æµè§ˆå™¨çš„å¼€å‘è€…å·¥å…·ã€‚åœ¨ Edge ä¸­ï¼Œä½ å¯ä»¥ç‚¹å‡»â€œè®¾ç½®åŠæ›´å¤šâ€ï¼ˆå³ä¸Šè§’ä¸‰ç‚¹å›¾æ ‡ï¼‰ï¼Œå‰å¾€â€œæ›´å¤šå·¥å…· > å¼€å‘äººå‘˜å·¥å…·â€ï¼Œç„¶åæ‰“å¼€ Performance é¢æ¿ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨å¿«æ·é”®ï¼šWindows ä¸Š `Ctrl` + `Shift` + `I`ï¼ŒMac ä¸Š `Option` + `Command` + `I`ã€‚

Performance é¢æ¿åŒ…å«æ€§èƒ½å‰–æå·¥å…·ã€‚æ‰“å¼€ä¸€ä¸ªç½‘ç«™ï¼ˆä¾‹å¦‚ï¼š[https://www.microsoft.com](https://www.microsoft.com/?WT.mc_id=academic-77807-sagibbon)ï¼‰ï¼Œç‚¹å‡»â€œRecordâ€å¼€å§‹å½•åˆ¶ï¼Œç„¶ååˆ·æ–°ç«™ç‚¹ã€‚éšæ—¶åœæ­¢å½•åˆ¶ï¼Œå³å¯æŸ¥çœ‹ç”¨äºâ€œè„šæœ¬ã€æ¸²æŸ“ã€ç»˜åˆ¶â€ç½‘ç«™çš„å„ç±»ä¾‹ç¨‹ï¼š

![Edge profiler](./images/profiler.png)

âœ… å‚é˜… Edge ä¸­ Performance é¢æ¿çš„[å¾®è½¯æ–‡æ¡£](https://docs.microsoft.com/microsoft-edge/devtools-guide/performance/?WT.mc_id=academic-77807-sagibbon)

> æç¤ºï¼šè‹¥æƒ³æ›´å‡†ç¡®åœ°è¯»å–ç½‘ç«™å¯åŠ¨æ—¶é—´ï¼Œè¯·æ¸…ç†æµè§ˆå™¨ç¼“å­˜

åœ¨æ—¶é—´è½´ä¸­é€‰æ‹©ç‰‡æ®µï¼Œå¯æ”¾å¤§æŸ¥çœ‹é¡µé¢åŠ è½½æœŸé—´å‘ç”Ÿçš„äº‹ä»¶ã€‚

é€‰æ‹©æ—¶é—´è½´çš„ä¸€æ®µåŒºåŸŸå¹¶æŸ¥çœ‹æ‘˜è¦çª—æ ¼ï¼Œå¯è·å¾—é¡µé¢æ€§èƒ½çš„å¿«ç…§ï¼š

![Edge profiler snapshot](./images/snapshot.png)

æŸ¥çœ‹ Event Log é¢æ¿ï¼Œæ ¸æŸ¥æ˜¯å¦å­˜åœ¨è€—æ—¶è¶…è¿‡ 15 ms çš„äº‹ä»¶ï¼š

![Edge event log](./images/log.png)

âœ… ç†Ÿæ‚‰ä½ çš„æ€§èƒ½å‰–æå™¨ï¼åœ¨æœ¬ç½‘ç«™æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œçœ‹çœ‹æ˜¯å¦å­˜åœ¨ç“¶é¢ˆã€‚åŠ è½½æœ€æ…¢çš„èµ„æºæ˜¯ä»€ä¹ˆï¼Ÿæœ€å¿«çš„åˆæ˜¯ä»€ä¹ˆï¼Ÿ

## å‰–ææ£€æŸ¥æ¸…å•

ä¸€èˆ¬è€Œè¨€ï¼Œåœ¨æ„å»ºç½‘ç«™æ—¶æœ‰ä¸€äº›å¸¸è§â€œé—®é¢˜åŒºåŸŸâ€éœ€è¦ç•™å¿ƒï¼Œé¿å…åœ¨ä¸Šçº¿æ—¶è¸©å‘ã€‚

**èµ„æºä½“ç§¯**ï¼šè¿‘å¹´æ¥ Web è¶Šæ¥è¶Šâ€œè‡ƒè‚¿â€ï¼ŒåŠ è½½ä¹Ÿæ›´æ…¢ï¼Œéƒ¨åˆ†åŸå› æ˜¯å›¾ç‰‡ä½“ç§¯ä¸ä½¿ç”¨ä¸å½“ã€‚

âœ… å‚è€ƒ [Internet Archive](https://httparchive.org/reports/page-weight) äº†è§£é¡µé¢ä½“ç§¯ç­‰å†å²è¶‹åŠ¿ã€‚

è‰¯å¥½å®è·µæ˜¯ç¡®ä¿å›¾ç‰‡ç»è¿‡ä¼˜åŒ–ï¼Œå¹¶æŒ‰åˆé€‚çš„å°ºå¯¸ä¸åˆ†è¾¨ç‡äº¤ä»˜ç»™ç”¨æˆ·ã€‚

**DOM éå†**ï¼šæµè§ˆå™¨éœ€è¦åŸºäºä½ çš„ä»£ç æ„å»º DOMã€‚ä¸ºæ€§èƒ½è€ƒè™‘ï¼Œåº”å°½é‡ä¿æŒæ ‡ç­¾ç²¾ç®€ï¼Œåªä½¿ç”¨å¹¶æ ·å¼åŒ–é¡µé¢çœŸæ­£éœ€è¦çš„å…ƒç´ ã€‚åŒç†ï¼Œå¤šä½™çš„ CSS å¯åšä¼˜åŒ–ï¼›ä»…åœ¨æŸä¸€é¡µä½¿ç”¨çš„æ ·å¼ä¸å¿…æ”¾å…¥å…¨å±€æ ·å¼è¡¨ã€‚

**JavaScript**ï¼šæ¯ä½ JS å¼€å‘è€…éƒ½åº”æ³¨æ„â€œé˜»å¡æ¸²æŸ“â€çš„è„šæœ¬ï¼Œå®ƒä»¬ä¼šé˜»æ­¢ DOM çš„ç»§ç»­éå†ä¸ç»˜åˆ¶ã€‚å¯è€ƒè™‘ä¸ºå†…è”è„šæœ¬åŠ ä¸Š `defer`ï¼ˆå¦‚åœ¨ Terrarium æ¨¡å—æ‰€ç¤ºï¼‰ã€‚

âœ… åœ¨ [Site Speed Test](https://www.webpagetest.org/) ç­‰ç½‘ç«™ä¸Šæµ‹è¯•ç«™ç‚¹ï¼Œäº†è§£è¡¡é‡ç«™ç‚¹æ€§èƒ½çš„å¸¸è§æ£€æŸ¥é¡¹ã€‚

æ—¢ç„¶ä½ å·²ç»äº†è§£äº†æµè§ˆå™¨å¦‚ä½•æ¸²æŸ“èµ„æºï¼Œä¸‹é¢å®Œæˆæ‰©å±•çš„æœ€åå‡ æ­¥ï¼š

### åˆ›å»ºç”¨äºè®¡ç®—é¢œè‰²çš„å‡½æ•°

åœ¨ `/src/index.js` ä¸­ï¼Œåœ¨ä¸€ç³»åˆ—ç”¨äºè®¿é—® DOM çš„ `const` å˜é‡ä¹‹åï¼Œæ–°å¢ `calculateColor()` å‡½æ•°ï¼š

```JavaScript
function calculateColor(value) {
  let co2Scale = [0, 150, 600, 750, 800];
  let colors = ['#2AA364', '#F5EB4D', '#9E4229', '#381D02', '#381D02'];

  let closestNum = co2Scale.sort((a, b) => {
    return Math.abs(a - value) - Math.abs(b - value);
  })[0];
  console.log(value + ' is closest to ' + closestNum);
  let num = (element) => element > closestNum;
  let scaleIndex = co2Scale.findIndex(num);

  let closestColor = colors[scaleIndex];
  console.log(scaleIndex, closestColor);

  chrome.runtime.sendMessage({ action: 'updateIcon', value: { color: closestColor } });
}
```

è¿™æ®µä»£ç åšäº†ä»€ä¹ˆï¼Ÿä½ ä¼šå°†ä¸Šä¸€è¯¾ä¸­ API è¿”å›çš„â€œç¢³å¼ºåº¦â€ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œç„¶åè®¡ç®—è¯¥å€¼ä¸é¢œè‰²æ•°ç»„ä¸­å„é˜ˆå€¼çš„æ¥è¿‘ç¨‹åº¦ï¼Œæœ€ç»ˆå¾—åˆ°å¯¹åº”çš„é¢œè‰²ï¼Œå¹¶æŠŠè¯¥é¢œè‰²å‘é€ç»™ chrome runtimeã€‚

chrome.runtime æä¾›äº†ç”¨äºå¤„ç†å„ç±»åå°ä»»åŠ¡çš„ [API](https://developer.chrome.com/extensions/runtime)ï¼Œä½ çš„æ‰©å±•æ­£æ˜¯å€ŸåŠ©å®ƒæ¥å®ç°ï¼š

> â€œä½¿ç”¨ chrome.runtime API å¯ä»¥è·å–åå°é¡µã€è¿”å›æ¸…å•è¯¦æƒ…ï¼Œå¹¶åœ¨åº”ç”¨æˆ–æ‰©å±•çš„ç”Ÿå‘½å‘¨æœŸä¸­ç›‘å¬ä¸å“åº”äº‹ä»¶ã€‚ä½ è¿˜å¯ä»¥ç”¨å®ƒå°†ç›¸å¯¹ URL è½¬ä¸ºç»å¯¹ URLã€‚â€

âœ… å¦‚æœä½ åœ¨ä¸º Edge å¼€å‘æ‰©å±•ï¼Œå¯èƒ½ä¼šæƒŠè®¶ä¸ºä½•ä½¿ç”¨ chrome çš„ APIã€‚æ–°ç‰ˆ Edge åŸºäº Chromium å¼•æ“æ„å»ºï¼Œå› æ­¤ä¹Ÿèƒ½ä½¿ç”¨è¿™äº›å·¥å…·ã€‚

> æ³¨æ„ï¼šè‹¥è¦ä¸ºæµè§ˆå™¨æ‰©å±•åšæ€§èƒ½å‰–æï¼Œåº”åœ¨æ‰©å±•è‡ªèº«ä¸­æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œå› ä¸ºå®ƒæ˜¯ç‹¬ç«‹çš„æµè§ˆå™¨å®ä¾‹ã€‚

### è®¾ç½®é»˜è®¤å›¾æ ‡é¢œè‰²

ç°åœ¨ï¼Œåœ¨ `init()` å‡½æ•°ä¸­ï¼Œè°ƒç”¨ chrome çš„ `updateIcon` æ“ä½œï¼Œå°†å›¾æ ‡é»˜è®¤è®¾ç½®ä¸ºç»¿è‰²ï¼š

```JavaScript
chrome.runtime.sendMessage({
  action: 'updateIcon',
    value: {
      color: 'green',
    },
});
```

### è°ƒç”¨å‡½æ•°å¹¶æ‰§è¡Œ

æ¥ç€ï¼Œå°†åˆšåˆ›å»ºçš„å‡½æ•°æ·»åŠ åˆ° CO2 Signal API è¿”å›çš„ promise é“¾ä¸­è¿›è¡Œè°ƒç”¨ï¼š

```JavaScript
//let CO2...
calculateColor(CO2);
```

æœ€åï¼Œåœ¨ `/dist/background.js` ä¸­æ·»åŠ ç›‘å¬å™¨ï¼Œä»¥å¤„ç†è¿™äº›åå°åŠ¨ä½œï¼š

```JavaScript
chrome.runtime.onMessage.addListener(function (msg, sender, sendResponse) {
  if (msg.action === 'updateIcon') {
    chrome.browserAction.setIcon({ imageData: drawIcon(msg.value) });
  }
});
//borrowed from energy lollipop extension, nice feature!
function drawIcon(value) {
  let canvas = document.createElement('canvas');
  let context = canvas.getContext('2d');

  context.beginPath();
  context.fillStyle = value.color;
  context.arc(100, 100, 50, 0, 2 * Math.PI);
  context.fill();

  return context.getImageData(50, 50, 100, 100);
}
```

ä»¥ä¸Šä»£ç ä¸ºåå°ä»»åŠ¡ç®¡ç†å™¨æ·»åŠ äº†ä¸€ä¸ªæ¶ˆæ¯ç›‘å¬å™¨ã€‚å½“æ”¶åˆ°åä¸º `updateIcon` çš„æ¶ˆæ¯æ—¶ï¼Œå°†ä½¿ç”¨ Canvas API ç»˜åˆ¶ç›¸åº”é¢œè‰²çš„å›¾æ ‡ã€‚

âœ… ä½ å°†åœ¨[å¤ªç©ºæ¸¸æˆè¯¾ç¨‹](../../6-space-game/2-drawing-to-canvas/README.md)ä¸­è¿›ä¸€æ­¥å­¦ä¹  Canvas APIã€‚

ç°åœ¨ï¼Œé‡æ–°æ„å»ºæ‰©å±•ï¼ˆ`npm run build`ï¼‰ï¼Œåˆ·æ–°å¹¶å¯åŠ¨æ‰©å±•ï¼Œè§‚å¯Ÿå›¾æ ‡é¢œè‰²çš„å˜åŒ–ã€‚æ˜¯ä¸æ˜¯è¯¥å»è·‘è…¿æˆ–æ´—ç¢—äº†ï¼Ÿç°åœ¨ä½ çŸ¥é“äº†ï¼

æ­å–œä½ ï¼Œå·²æ„å»ºå‡ºä¸€ä¸ªå®ç”¨çš„æµè§ˆå™¨æ‰©å±•ï¼Œå¹¶è¿›ä¸€æ­¥äº†è§£äº†æµè§ˆå™¨çš„å·¥ä½œæ–¹å¼ä¸æ€§èƒ½å‰–ææ–¹æ³•ã€‚

---

## ğŸš€ æŒ‘æˆ˜

æ‰¾å‡ ä¸ªå†å²æ‚ ä¹…çš„å¼€æºç½‘ç«™ï¼Œæ ¹æ®å®ƒä»¬çš„ GitHub å†å²åˆ†æå…¶åœ¨è¿™äº›å¹´é‡Œå¦‚ä½•åšæ€§èƒ½ä¼˜åŒ–ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ã€‚æœ€å¸¸è§çš„ç—›ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ

## è¯¾åæµ‹éªŒ

[Post-lecture quiz](https://ff-quizzes.netlify.app/web/quiz/28)

## å¤ä¹ ä¸è‡ªå­¦

è€ƒè™‘è®¢é˜…ä¸€ä»½[æ€§èƒ½ç›¸å…³çš„ Newsletter](https://perf.email/)

åœ¨å„æµè§ˆå™¨çš„å¼€å‘è€…å·¥å…·ä¸­æŸ¥çœ‹ Performance é¢æ¿ï¼Œäº†è§£å®ƒä»¬è¯„ä¼° Web æ€§èƒ½çš„æ–¹å¼ã€‚ä½ å‘ç°äº†å“ªäº›ä¸»è¦å·®å¼‚ï¼Ÿ

## ä½œä¸š

[åˆ†ææŸç½‘ç«™çš„æ€§èƒ½](assignment.md)
